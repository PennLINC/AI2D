{% comment %}
Reusable dataset/study page renderer that pulls values from `_data/nichart_data_overview.csv`.

Usage in a dataset post/page:

---
title: "OASIS"
layout: single
categories: datasets
study_abbr: OASIS
---
{% include datasets/nichart_study_page.html %}

Optionally override lookup key:
{% include datasets/nichart_study_page.html study_abbr="OASIS" %}
{% endcomment %}

{% assign study_abbr = include.study_abbr | default: page.study_abbr | default: page.excerpt | default: page.title %}
{% assign rows = site.data.nichart_data_overview | where: "Study_abbr", study_abbr %}
{% assign row = rows | first %}

{% if row == nil %}
<div class="notice--warning">
  <strong>Dataset metadata not found.</strong>
  No row in <code>_data/nichart_data_overview.csv</code> matched <code>Study_abbr={{ study_abbr }}</code>.
</div>
{% else %}
{% assign website_url = row["Website"] | default: page.study_website %}
{% assign manuscript_url = row["Manuscript"] | default: page.data_paper %}
{% assign dua_url = row["DUA"] | default: page.dua %}
{% assign primary_desc = row["Primary_Description"] %}
{% assign disease_tags = row["Disease_Tags"] %}
{% assign study_full = row["Study_full"] %}
{% assign study_overview = row["Study_Overview"] %}
{% assign country_region = row["Country/Region"] %}
{% assign pct_female = row["% Female"] | default: page.p_female %}
{% assign age_mean_sd = row["Age (mean ± SD)"] | default: page.age_avg %}

### About the dataset

{% if primary_desc and primary_desc != "" %}
**Primary description:** {{ primary_desc }}
{% endif %}

{% if study_overview and study_overview != "" %}
{{ study_overview }}
{% endif %}

<div class="table" align="center">
  <table style="text-align:center; width:100%; font-size:18px; border:1px solid black">
    <tr>
      <th style="font-weight:bold; width:250px;">Study</th>
      <th style="font-weight:normal">{{ study_full | default: page.title }}</th>
      <th style="font-weight:normal"></th>
    </tr>

    {% if website_url and website_url != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">Study Website</th>
      <th style="font-weight:normal"><a href="{{ website_url }}">{{ study_abbr }}</a></th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if manuscript_url and manuscript_url != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">Manuscript</th>
      <th style="font-weight:normal"><a href="{{ manuscript_url }}">{{ manuscript_url }}</a></th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if dua_url and dua_url != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">DUA</th>
      <th style="font-weight:normal">
        {% if dua_url contains "http" %}
          <a href="{{ dua_url }}">{{ dua_url }}</a>
        {% else %}
          {{ dua_url }}
        {% endif %}
      </th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if country_region and country_region != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">Country/Region</th>
      <th style="font-weight:normal">{{ country_region }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if disease_tags and disease_tags != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">Disease Tags</th>
      <th style="font-weight:normal">{{ disease_tags }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if age_mean_sd and age_mean_sd != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">Age (mean ± SD)</th>
      <th style="font-weight:normal">{{ age_mean_sd }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if pct_female and pct_female != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">% Female</th>
      <th style="font-weight:normal">{{ pct_female }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% comment %}=== Standard rendering for all datasets (single-row values) ==={% endcomment %}
    {% assign age_range = row["age_range"] | default: page.age_range %}
    {% assign n_subject = row["N_subject"] | default: page.sample_size %}
    {% assign n_mr_session = row["N_MR_session"] | default: page.number_of_sessions %}
    {% assign cubic_path = row["CUBIC"] | default: page.cubic_path %}

    {% if age_range and age_range != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">Age Range</th>
      <th style="font-weight:normal">{{ age_range }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if n_subject and n_subject != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">N Subjects</th>
      <th style="font-weight:normal">{{ n_subject }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if n_mr_session and n_mr_session != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">N MR Sessions</th>
      <th style="font-weight:normal">{{ n_mr_session }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if cubic_path and cubic_path != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">CUBIC Project</th>
      <th style="font-weight:normal">
        <div id="{{ study_abbr | downcase }}-cubic" class="copy-container" style="border: 1px solid #6c6edc; border-radius: 3px; padding: 6px; background-color: #f8f9fa;">
          <span class="copy-text"><code>{{ cubic_path }}</code></span>
          <button class="copy-button" onclick="copyToClipboard('{{ study_abbr | downcase }}-cubic')">Copy</button>
        </div>
      </th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% assign dlmuse_path = row["DLMUSE"] %}
    {% assign dlmuse_version = row["DLMUSE_version"] %}
    {% assign dlmuse_complete = row["DLMUSE_N_ses_completed"] %}
    {% assign dlwmls_path = row["DLWMLS"] %}
    {% assign dlwmls_version = row["DLWMLS_version"] %}
    {% assign dlwmls_complete = row["DLWMLS_N_ses_completed"] %}
    {% assign fmriprep_path = row["fMRIPrep"] %}
    {% assign fmriprep_version = row["fMRIPrep_version"] %}
    {% assign fmriprep_complete = row["fMRIPrep_N_ses_completed"] %}
    {% assign fmriprep_command = row["fMRIPrep_command"] %}
    {% assign xcpd_path = row["XCP-D"] %}
    {% assign xcpd_version = row["XCP-D_version"] %}
    {% assign xcpd_complete = row["XCP-D_N_ses_completed"] %}
    {% assign xcpd_command = row["XCP-D_command"] %}

    {% assign pipelines = "" | split: "," %}
    {% if dlmuse_path and dlmuse_path != "" %}{% assign pipelines = pipelines | push: "DLMUSE" %}{% endif %}
    {% if dlwmls_path and dlwmls_path != "" %}{% assign pipelines = pipelines | push: "DLWMLS" %}{% endif %}
    {% if fmriprep_path and fmriprep_path != "" %}{% assign pipelines = pipelines | push: "fMRIPrep" %}{% endif %}
    {% if xcpd_path and xcpd_path != "" %}{% assign pipelines = pipelines | push: "XCP-D" %}{% endif %}

    {% for p in pipelines %}
      {% assign p_key = p %}
      {% assign p_id = p | downcase | replace: ".", "-" | replace: " ", "-" %}
      {% assign p_command_col = p_key | append: "_command" %}
      {% assign p_has_command = false %}
      {% assign p_command_raw = row[p_command_col] %}
      
      {% if p == "DLMUSE" %}
        {% assign p_path = dlmuse_path %}
        {% assign p_version = dlmuse_version %}
        {% assign p_complete = dlmuse_complete %}
      {% elsif p == "DLWMLS" %}
        {% assign p_path = dlwmls_path %}
        {% assign p_version = dlwmls_version %}
        {% assign p_complete = dlwmls_complete %}
      {% elsif p == "fMRIPrep" %}
        {% assign p_path = fmriprep_path %}
        {% assign p_version = fmriprep_version %}
        {% assign p_complete = fmriprep_complete %}
        {% if fmriprep_command and fmriprep_command != "" %}
          {% assign p_has_command = true %}
          {% assign p_command_raw = fmriprep_command %}
        {% endif %}
      {% elsif p == "XCP-D" %}
        {% assign p_path = xcpd_path %}
        {% assign p_version = xcpd_version %}
        {% assign p_complete = xcpd_complete %}
        {% if xcpd_command and xcpd_command != "" %}
          {% assign p_has_command = true %}
          {% assign p_command_raw = xcpd_command %}
        {% endif %}
      {% endif %}

      <tr>
        <th style="font-weight:bold; width:250px;">
          {{ p_key }}
          {% if p_version and p_version != "" %}
            <span style="font-weight:normal;">({{ p_version }})</span>
          {% endif %}
          {% if p_complete and p_complete != "" and n_mr_session and n_mr_session != "" %}
            <br>
            <span style="font-weight:normal;">({{ p_complete }}/{{ n_mr_session }} complete)</span>
          {% endif %}
        </th>
        <th style="font-weight:normal">
          {% if p_has_command %}
            {% comment %}Show tabs for Path and Command{% endcomment %}
            <div class="tab-container">
              <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('{{ study_abbr | downcase }}-{{ p_id }}-path-tab')">Path</button>
                <button class="tab-button" onclick="showTab('{{ study_abbr | downcase }}-{{ p_id }}-command-tab')">Command</button>
              </div>
              <div id="{{ study_abbr | downcase }}-{{ p_id }}-path-tab" class="tab-content active">
                <div id="{{ study_abbr | downcase }}-{{ p_id }}-path" class="copy-container" style="border: 1px solid #6c6edc; border-radius: 3px; padding: 6px; background-color: #f8f9fa;">
                  <span class="copy-text"><code>{{ p_path }}</code></span>
                  <button class="copy-button" onclick="copyToClipboard('{{ study_abbr | downcase }}-{{ p_id }}-path')">Copy</button>
                </div>
              </div>
              <div id="{{ study_abbr | downcase }}-{{ p_id }}-command-tab" class="tab-content">
                {% comment %}Handle OASIS3/OASIS4 splitting for commands{% endcomment %}
                {% if study_abbr == "OASIS" and p_command_raw contains "OASIS3=" %}
                  {% assign command_parts = p_command_raw | split: ";" %}
                  {% for cmd_part in command_parts %}
                    {% if cmd_part contains "OASIS3=" %}
                      {% assign oasis3_parts = cmd_part | split: "OASIS3=" %}
                      {% if oasis3_parts.size >= 2 %}
                        {% assign cmd_value = oasis3_parts[1] | strip %}
                        <div style="margin-bottom: 15px;">
                          <strong>OASIS3:</strong>
                          <div id="{{ study_abbr | downcase }}-{{ p_id }}-oasis3-command" class="copy-container" style="border: 1px solid #6c6edc; border-radius: 3px; padding: 6px; background-color: #f8f9fa; margin-top: 5px; flex-direction: column; align-items: stretch;">
                            <div class="copy-text" style="flex: 1; overflow-x: auto; margin: 0; padding: 8px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 3px;">
                              <code style="display: block; white-space: pre-wrap; word-break: break-all; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4; color: #333;">{{ cmd_value | replace: "<", "&lt;" | replace: ">", "&gt;" }}</code>
                            </div>
                            <button class="copy-button" onclick="copyToClipboard('{{ study_abbr | downcase }}-{{ p_id }}-oasis3-command')" style="align-self: flex-end; margin-top: 8px;">Copy</button>
                          </div>
                        </div>
                      {% endif %}
                    {% endif %}
                    {% if cmd_part contains "OASIS4=" %}
                      {% assign oasis4_parts = cmd_part | split: "OASIS4=" %}
                      {% if oasis4_parts.size >= 2 %}
                        {% assign cmd_value = oasis4_parts[1] | strip %}
                        <div style="margin-bottom: 15px;">
                          <strong>OASIS4:</strong>
                          <div id="{{ study_abbr | downcase }}-{{ p_id }}-oasis4-command" class="copy-container" style="border: 1px solid #6c6edc; border-radius: 3px; padding: 6px; background-color: #f8f9fa; margin-top: 5px; flex-direction: column; align-items: stretch;">
                            <div class="copy-text" style="flex: 1; overflow-x: auto; margin: 0; padding: 8px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 3px;">
                              <code style="display: block; white-space: pre-wrap; word-break: break-all; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4; color: #333;">{{ cmd_value | replace: "<", "&lt;" | replace: ">", "&gt;" }}</code>
                            </div>
                            <button class="copy-button" onclick="copyToClipboard('{{ study_abbr | downcase }}-{{ p_id }}-oasis4-command')" style="align-self: flex-end; margin-top: 8px;">Copy</button>
                          </div>
                        </div>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                {% else %}
                  {% comment %}Single command (non-OASIS or no OASIS3/OASIS4 pattern){% endcomment %}
                  <div id="{{ study_abbr | downcase }}-{{ p_id }}-command" class="copy-container" style="border: 1px solid #6c6edc; border-radius: 3px; padding: 6px; background-color: #f8f9fa; flex-direction: column; align-items: stretch;">
                    <div class="copy-text" style="flex: 1; overflow-x: auto; margin: 0; padding: 8px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 3px;">
                      <code style="display: block; white-space: pre-wrap; word-break: break-all; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4; color: #333;">{{ p_command_raw | replace: "<", "&lt;" | replace: ">", "&gt;" }}</code>
                    </div>
                    <button class="copy-button" onclick="copyToClipboard('{{ study_abbr | downcase }}-{{ p_id }}-command')" style="align-self: flex-end; margin-top: 8px;">Copy</button>
                  </div>
                {% endif %}
              </div>
            </div>
          {% else %}
            {% comment %}No command, just show path{% endcomment %}
            <div id="{{ study_abbr | downcase }}-{{ p_id }}-path" class="copy-container" style="border: 1px solid #6c6edc; border-radius: 3px; padding: 6px; background-color: #f8f9fa;">
              <span class="copy-text"><code>{{ p_path }}</code></span>
              <button class="copy-button" onclick="copyToClipboard('{{ study_abbr | downcase }}-{{ p_id }}-path')">Copy</button>
            </div>
          {% endif %}
        </th>
        <th style="font-weight:normal"></th>
      </tr>
    {% endfor %}
  </table>
</div>

{% include datasets/copy_widgets.html %}

{% assign grants = row["Grants"] %}
{% if grants and grants != "" %}
<br>

*Funding*
<br>
{{ grants }}
{% endif %}

{% endif %}

