{% comment %}
Reusable dataset/study page renderer that pulls values from `_data/nichart_data_overview.csv`.

Usage in a dataset post/page:

---
title: "OASIS"
layout: single
categories: datasets
study_abbr: OASIS
---
{% include datasets/nichart_study_page.html %}

Optionally override lookup key:
{% include datasets/nichart_study_page.html study_abbr="OASIS" %}
{% endcomment %}

{% assign study_abbr = include.study_abbr | default: page.study_abbr | default: page.excerpt | default: page.title %}
{% assign rows = site.data.nichart_data_overview | where: "Study_abbr", study_abbr %}
{% assign row = rows | first %}

{% if row == nil %}
<div class="notice--warning">
  <strong>Dataset metadata not found.</strong>
  No row in <code>_data/nichart_data_overview.csv</code> matched <code>Study_abbr={{ study_abbr }}</code>.
</div>
{% else %}
{% assign website_url = row["Website"] | default: page.study_website %}
{% assign manuscript_url = row["Manuscript"] | default: page.data_paper %}
{% assign dua_url = row["DUA"] | default: page.dua %}
{% assign primary_desc = row["Primary_Description"] %}
{% assign disease_tags = row["Disease_Tags"] %}
{% assign study_full = row["Study_full"] %}
{% assign study_overview = row["Study_Overview"] %}
{% assign country_region = row["Country/Region"] %}
{% assign pct_female = row["% Female"] | default: page.p_female %}
{% assign age_mean_sd = row["Age (mean ± SD)"] | default: page.age_avg %}

### About the dataset

{% if primary_desc and primary_desc != "" %}
**Primary description:** {{ primary_desc }}
{% endif %}

{% if study_overview and study_overview != "" %}
{{ study_overview }}
{% endif %}

<div class="table" align="center">
  <table style="text-align:center; width:100%; font-size:18px; border:1px solid black">
    <tr>
      <th style="font-weight:bold; width:250px;">Study</th>
      <th style="font-weight:normal">{{ study_full | default: page.title }}</th>
      <th style="font-weight:normal"></th>
    </tr>

    {% if website_url and website_url != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">Study Website</th>
      <th style="font-weight:normal"><a href="{{ website_url }}">{{ study_abbr }}</a></th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if manuscript_url and manuscript_url != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">Data Descriptor Paper</th>
      <th style="font-weight:normal">
        {% assign manuscripts = manuscript_url | split: ";" %}
        {% for manuscript in manuscripts %}
          {% assign manuscript_trimmed = manuscript | strip %}
          {% if manuscript_trimmed != "" %}
            <a href="{{ manuscript_trimmed }}">{{ manuscript_trimmed }}</a>
            {% unless forloop.last %}<br>{% endunless %}
          {% endif %}
        {% endfor %}
      </th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if dua_url and dua_url != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">DUA</th>
      <th style="font-weight:normal">
        {% assign duas = dua_url | split: ";" %}
        {% for dua in duas %}
          {% assign dua_trimmed = dua | strip %}
          {% if dua_trimmed != "" %}
            {% if dua_trimmed contains "http" %}
              <a href="{{ dua_trimmed }}">{{ dua_trimmed }}</a>
            {% else %}
              {{ dua_trimmed }}
            {% endif %}
            {% unless forloop.last %}<br>{% endunless %}
          {% endif %}
        {% endfor %}
      </th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if country_region and country_region != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">Country/Region</th>
      <th style="font-weight:normal">{{ country_region }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if disease_tags and disease_tags != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">Disease Tag</th>
      <th style="font-weight:normal">{{ disease_tags }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% assign age_range = row["age_range"] | default: page.age_range %}
    {% assign age_range_has_semicolon = false %}
    {% if age_range and age_range != "" and age_range contains ";" %}
      {% assign age_range_has_semicolon = true %}
    {% endif %}

    {% assign n_subject = row["N_subject"] | default: page.sample_size %}
    {% assign n_mr_session = row["N_MR_session"] | default: page.number_of_sessions %}
    {% assign n_subject_has_semicolon = false %}
    {% if n_subject and n_subject != "" and n_subject contains ";" %}
      {% assign n_subject_has_semicolon = true %}
    {% endif %}
    {% assign n_mr_session_has_semicolon = false %}
    {% if n_mr_session and n_mr_session != "" and n_mr_session contains ";" %}
      {% assign n_mr_session_has_semicolon = true %}
    {% endif %}
    {% assign age_show_complete_note = false %}
    {% if n_subject_has_semicolon == false and n_mr_session_has_semicolon == false and n_subject != "" and n_mr_session != "" %}
      {% assign n_subject_num = n_subject | plus: 0 %}
      {% assign n_mr_session_num = n_mr_session | plus: 0 %}
      {% if n_subject_num < n_mr_session_num %}
        {% assign age_show_complete_note = true %}
      {% endif %}
    {% endif %}

    {% if age_mean_sd and age_mean_sd != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">Age (mean ± SD)
            {% if age_show_complete_note %}
              <br>
              <span style="font-weight:normal;">(Baseline)</span>
            {% endif %}
          </th>
      <th style="font-weight:normal">{{ age_mean_sd }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if age_range and age_range != "" and age_range_has_semicolon == false %}
    <tr>
      <th style="font-weight:bold; width:250px;">Age Range
            {% if age_show_complete_note %}
              <br>
              <span style="font-weight:normal;">(Baseline)</span>
            {% endif %}
          </th>
      <th style="font-weight:normal">{{ age_range }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if pct_female and pct_female != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">% Female</th>
      <th style="font-weight:normal">{{ pct_female }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% comment %}=== Standard rendering for all datasets (single-row values) ==={% endcomment %}
    {% assign cubic_path = row["CUBIC"] | default: page.cubic_path %}

    {% if cubic_path and cubic_path != "" %}
    <tr>
      <th style="font-weight:bold; width:250px;">CUBIC Project</th>
      <th style="font-weight:normal">{{ cubic_path }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    <tr>
      <th style="font-weight:bold; width:250px;">PI for Access Approval</th>
      <th style="font-weight:normal">Christos Davatzikos</th>
      <th style="font-weight:normal"></th>
    </tr>

    {% if n_subject and n_subject != "" and n_subject_has_semicolon == false %}
    <tr>
      <th style="font-weight:bold; width:250px;">N Subjects</th>
      <th style="font-weight:normal">{{ n_subject }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% if n_mr_session and n_mr_session != "" and n_mr_session_has_semicolon == false %}
    <tr>
      <th style="font-weight:bold; width:250px;">N MR Sessions</th>
      <th style="font-weight:normal">{{ n_mr_session }}</th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% assign dx_cols = "DX_AD,DX_Hypertension,DX_Diabetes,DX_Heart,DX_Stroke,DX_Psychosis,DX_Schizophrenia,DX_Depression,DX_Bipolar,DX_Hyperlipidemia,DX_TBI,DX_Anxiety,DX_Psychological_Disorder" | split: "," %}
    {% assign dx_has_any = false %}
    {% for dx_col in dx_cols %}
      {% assign dx_val = row[dx_col] | strip %}
      {% if dx_val != "" %}
        {% assign dx_lines = dx_val | newline_to_br | split: "<br />" %}
        {% assign dx_non_empty = "" | split: "," %}
        {% for dx_line in dx_lines %}
          {% assign dx_trimmed = dx_line | strip %}
          {% if dx_trimmed != "" %}
            {% assign dx_non_empty = dx_non_empty | push: dx_trimmed %}
          {% endif %}
        {% endfor %}
        {% assign only_nan = false %}
        {% if dx_non_empty.size == 1 %}
          {% assign first_part = dx_non_empty[0] | slice: 0, 3 %}
          {% if first_part == "NaN" or first_part == "nan" %}
            {% assign only_nan = true %}
          {% endif %}
        {% endif %}
        {% unless only_nan %}
          {% assign dx_has_any = true %}
        {% endunless %}
      {% endif %}
    {% endfor %}
    {% if dx_has_any %}
    <tr>
      <th style="font-weight:bold; width:250px;">Diagnoses</th>
      <th style="font-weight:normal">
        <div style="font-size: 14px; display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-start;">
          {% for dx_col in dx_cols %}
            {% assign dx_val = row[dx_col] | strip %}
            {% if dx_val != "" %}
              {% assign dx_lines = dx_val | newline_to_br | split: "<br />" %}
              {% assign dx_non_empty = "" | split: "," %}
              {% for dx_line in dx_lines %}
                {% assign dx_trimmed = dx_line | strip %}
                {% if dx_trimmed != "" %}
                  {% assign dx_non_empty = dx_non_empty | push: dx_trimmed %}
                {% endif %}
              {% endfor %}
              {% assign only_nan = false %}
              {% if dx_non_empty.size == 1 %}
                {% assign first_part = dx_non_empty[0] | slice: 0, 3 %}
                {% if first_part == "NaN" or first_part == "nan" %}
                  {% assign only_nan = true %}
                {% endif %}
              {% endif %}
              {% assign dx_visit_format = false %}
              {% if dx_val contains " | " and dx_val contains "[" %}
                {% assign dx_visit_format = true %}
              {% endif %}
              {% assign dx_visit_only_nan = false %}
              {% if dx_visit_format %}
                {% comment %}Parse visit format to compute dx_visit_only_nan and arrays for table{% endcomment %}
                {% assign dx_blocks = dx_val | split: " | " %}
                {% assign dx_visits_delim = "|" %}
                {% assign dx_values_delim = "|" %}
                {% assign dx_lookup = "" %}
                {% for dx_b in dx_blocks %}
                  {% assign dx_block_trimmed = dx_b | strip %}
                  {% if dx_block_trimmed != "" and dx_block_trimmed contains " [" %}
                    {% assign dx_b_parts = dx_block_trimmed | split: " [" %}
                    {% assign dx_visit = dx_b_parts[0] | strip %}
                    {% assign dx_content = dx_b_parts[1] | remove: "]" | strip %}
                    {% assign dx_check_visit = "|" | append: dx_visit | append: "|" %}
                    {% unless dx_visits_delim contains dx_check_visit %}
                      {% assign dx_visits_delim = dx_visits_delim | append: dx_visit | append: "|" %}
                    {% endunless %}
                    {% assign dx_pairs = dx_content | split: "," %}
                    {% for dx_pair in dx_pairs %}
                      {% assign dx_pair_trimmed = dx_pair | strip %}
                      {% if dx_pair_trimmed != "" %}
                        {% assign dx_vn = dx_pair_trimmed | split: ":" %}
                        {% assign dx_v = dx_vn[0] | strip %}
                        {% assign dx_n = dx_vn[1] | strip %}
                        {% assign dx_check_val = "|" | append: dx_v | append: "|" %}
                        {% unless dx_values_delim contains dx_check_val %}
                          {% assign dx_values_delim = dx_values_delim | append: dx_v | append: "|" %}
                        {% endunless %}
                        {% assign dx_lookup = dx_lookup | append: dx_visit | append: "_" | append: dx_v | append: ":" | append: dx_n | append: "," %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                {% endfor %}
                {% assign dx_visits_arr = dx_visits_delim | split: "|" %}
                {% assign dx_values_arr = dx_values_delim | split: "|" %}
                {% assign dx_visit_only_nan = true %}
                {% for dx_vv in dx_values_arr %}
                  {% if dx_vv != "" %}
                    {% assign dx_vv_lower = dx_vv | downcase %}
                    {% if dx_vv_lower != "nan" %}
                      {% assign dx_visit_only_nan = false %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
              {% endif %}
              {% unless only_nan or dx_visit_only_nan %}
                {% assign dx_label = dx_col | replace: "DX_", "" | replace: "_", " " %}
                <div style="margin: 0;">
                  <div style="text-align: left; font-weight: bold; padding: 4px 0 8px 0;">{{ dx_label }}</div>
                  <table style="margin: 0; border-collapse: collapse; border: 1px solid #ddd;">
                  {% if dx_visit_format %}
                  <thead>
                    <tr style="background: #f5f5f5;">
                      <th style="border: 1px solid #ddd; padding: 6px 10px; text-align: left;">Value</th>
                      {% for dx_visit in dx_visits_arr %}
                        {% if dx_visit != "" %}
                      <th style="border: 1px solid #ddd; padding: 6px 10px; text-align: right;">{{ dx_visit }}</th>
                        {% endif %}
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for dx_val_row in dx_values_arr %}
                      {% if dx_val_row != "" %}
                        <tr>
                          <td style="border: 1px solid #ddd; padding: 6px 10px;">{{ dx_val_row }}</td>
                          {% for dx_visit in dx_visits_arr %}
                            {% if dx_visit != "" %}
                              {% assign dx_cell_key = dx_visit | append: "_" | append: dx_val_row | append: ":" %}
                              {% assign dx_lookup_entries = dx_lookup | split: "," %}
                              {% assign dx_cell_n = "" %}
                              {% for dx_entry in dx_lookup_entries %}
                                {% if dx_entry contains dx_cell_key %}
                                  {% assign dx_cell_n = dx_entry | replace: dx_cell_key, "" %}
                                {% endif %}
                              {% endfor %}
                          <td style="border: 1px solid #ddd; padding: 6px 10px; text-align: right;">{{ dx_cell_n }}</td>
                            {% endif %}
                          {% endfor %}
                        </tr>
                      {% endif %}
                    {% endfor %}
                  </tbody>
                  {% else %}
                    {% comment %}Legacy: single Value / N table{% endcomment %}
                  <thead>
                    <tr style="background: #f5f5f5;">
                      <th style="border: 1px solid #ddd; padding: 6px 10px; text-align: left;">Value</th>
                      <th style="border: 1px solid #ddd; padding: 6px 10px; text-align: right;">N</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for dx_line in dx_non_empty %}
                      {% assign dx_line_trimmed = dx_line | strip %}
                      {% if dx_line_trimmed != "" %}
                        {% assign line_parts = dx_line_trimmed | split: " " %}
                        {% assign dx_count = line_parts | last %}
                        {% capture dx_value_str %}{% for p in line_parts %}{% unless forloop.last %}{% if p != "" %}{{ p }} {% endif %}{% endunless %}{% endfor %}{% endcapture %}
                        {% assign dx_value = dx_value_str | strip %}
                        <tr>
                          <td style="border: 1px solid #ddd; padding: 6px 10px;">{{ dx_value }}</td>
                          <td style="border: 1px solid #ddd; padding: 6px 10px; text-align: right;">{{ dx_count }}</td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                  </tbody>
                  {% endif %}
                </table>
                </div>
              {% endunless %}
            {% endif %}
          {% endfor %}
        </div>
      </th>
      <th style="font-weight:normal"></th>
    </tr>
    {% endif %}

    {% assign dlmuse_path = row["DLMUSE"] %}
    {% assign dlmuse_version = row["DLMUSE_version"] %}
    {% assign dlmuse_complete = row["DLMUSE_N_ses_completed"] %}
    {% assign ravens_path = row["RAVENS"] %}
    {% assign ravens_version = row["RAVENS_version"] %}
    {% assign ravens_complete = row["RAVENS_N_ses_completed"] %}
    {% assign dlwmls_path = row["DLWMLS"] %}
    {% assign dlwmls_version = row["DLWMLS_version"] %}
    {% assign dlwmls_complete = row["DLWMLS_N_ses_completed"] %}
    {% assign fmriprep_path = row["fMRIPrep"] %}
    {% assign fmriprep_version = row["fMRIPrep_version"] %}
    {% assign fmriprep_complete = row["fMRIPrep_N_ses_completed"] %}
    {% assign fmriprep_command = row["fMRIPrep_command"] %}
    {% assign xcpd_path = row["XCP-D"] %}
    {% assign xcpd_version = row["XCP-D_version"] %}
    {% assign xcpd_complete = row["XCP-D_N_ses_completed"] %}
    {% assign xcpd_command = row["XCP-D_command"] %}
    {% assign t1_n_ses = row["T1_N_ses"] %}
    {% assign fl_n_ses = row["FL_N_ses"] %}
    {% assign nonimaging_raw = row["nonimaging_raw"] %}
    {% assign nonimaging_data_dictionary = row["Data_Dictionary"] %}
    {% assign nonimaging_consolidated_v2 = "/cbica/projects/ISTAGING/Pipelines/ISTAGING_Data_Consolidation_2020/v2.0/istaging.csv" %}
    {% assign nonimaging_consolidated_latest = "Coming Soon" %}
    {% assign nonimaging_consolidated_v2_study = row["nonimaging_consolidated_latest_study"] %}
    {% assign nonimaging_consolidation_base = "/cbica/projects/ISTAGING/Pipelines/ISTAGING_Data_Consolidation_2020/v2.0" %}

    {% assign section_keys = "" | split: "," %}
    {% assign section_fields = "" | split: "," %}
    {% assign section_fields = section_fields | push: age_range | push: n_subject | push: n_mr_session | push: dlmuse_path | push: dlmuse_version | push: dlmuse_complete | push: ravens_path | push: ravens_version | push: ravens_complete | push: dlwmls_path | push: dlwmls_version | push: dlwmls_complete | push: fmriprep_path | push: fmriprep_version | push: fmriprep_complete | push: fmriprep_command | push: xcpd_path | push: xcpd_version | push: xcpd_complete | push: xcpd_command %}
    {% for field_value in section_fields %}
      {% if field_value and field_value != "" %}
        {% assign field_parts = field_value | split: ";" %}
        {% for part in field_parts %}
          {% assign part_stripped = part | strip %}
          {% if part_stripped contains "=" %}
            {% assign kv = part_stripped | split: "=" %}
            {% assign key = kv[0] | strip %}
            {% assign first_char = key | slice: 0 %}
            {% if key != "" and first_char != "/" and first_char != "-" %}
              {% unless key contains " " %}
                {% unless section_keys contains key %}
                  {% assign section_keys = section_keys | push: key %}
                {% endunless %}
              {% endunless %}
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endfor %}

    {% assign has_sections = true %}
    {% if section_keys.size == 0 %}
      {% assign section_keys = "default" | split: "," %}
      {% assign has_sections = false %}
    {% endif %}

    {% for section_key in section_keys %}
      {% if has_sections %}
      <tr>
        <th colspan="3" style="font-weight:bold; text-align:left; background:#f2f4ff; border-top:2px solid #d7dcff;">{{ section_key }}</th>
      </tr>
      {% endif %}

      {% if has_sections %}
        {% assign key_prefix = section_key | append: "=" %}

        {% assign section_age_range = age_range %}
        {% if age_range and age_range contains "=" %}
          {% assign section_age_range = "" %}
          {% assign age_parts = age_range | split: ";" %}
          {% for part in age_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_age_range = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_n_subject = n_subject %}
        {% if n_subject and n_subject contains "=" %}
          {% assign section_n_subject = "" %}
          {% assign n_subject_parts = n_subject | split: ";" %}
          {% for part in n_subject_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_n_subject = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_n_mr_session = n_mr_session %}
        {% if n_mr_session and n_mr_session contains "=" %}
          {% assign section_n_mr_session = "" %}
          {% assign n_mr_parts = n_mr_session | split: ";" %}
          {% for part in n_mr_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_n_mr_session = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_t1_n_ses = t1_n_ses %}
        {% if t1_n_ses and t1_n_ses contains "=" %}
          {% assign section_t1_n_ses = "" %}
          {% assign t1_n_ses_parts = t1_n_ses | split: ";" %}
          {% for part in t1_n_ses_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_t1_n_ses = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_fl_n_ses = fl_n_ses %}
        {% if fl_n_ses and fl_n_ses contains "=" %}
          {% assign section_fl_n_ses = "" %}
          {% assign fl_n_ses_parts = fl_n_ses | split: ";" %}
          {% for part in fl_n_ses_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_fl_n_ses = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% else %}
        {% assign section_age_range = age_range %}
        {% assign section_n_subject = n_subject %}
        {% assign section_n_mr_session = n_mr_session %}
        {% assign section_t1_n_ses = t1_n_ses %}
        {% assign section_fl_n_ses = fl_n_ses %}
      {% endif %}

      {% assign section_age_show_complete_note = false %}
      {% if section_n_subject != "" and section_n_mr_session != "" %}
        {% assign section_n_subject_num = section_n_subject | plus: 0 %}
        {% assign section_n_mr_session_num = section_n_mr_session | plus: 0 %}
        {% if section_n_subject_num < section_n_mr_session_num %}
          {% assign section_age_show_complete_note = true %}
        {% endif %}
      {% endif %}
      {% if section_age_range and section_age_range != "" and age_range_has_semicolon %}
      <tr>
        <th style="font-weight:bold; width:250px;">Age Range
            {% if section_age_show_complete_note %}
              <br>
              <span style="font-weight:normal;">(Baseline)</span>
            {% endif %}
          </th>
        <th style="font-weight:normal">{{ section_age_range }}</th>
        <th style="font-weight:normal"></th>
      </tr>
      {% endif %}

      {% if section_n_subject and section_n_subject != "" and n_subject_has_semicolon %}
      <tr>
        <th style="font-weight:bold; width:250px;">N Subjects</th>
        <th style="font-weight:normal">{{ section_n_subject }}</th>
        <th style="font-weight:normal"></th>
      </tr>
      {% endif %}

      {% if section_n_mr_session and section_n_mr_session != "" and n_mr_session_has_semicolon %}
      <tr>
        <th style="font-weight:bold; width:250px;">N MR Sessions</th>
        <th style="font-weight:normal">{{ section_n_mr_session }}</th>
        <th style="font-weight:normal"></th>
      </tr>
      {% endif %}

      {% if has_sections %}
        {% assign section_dlmuse_path = dlmuse_path %}
        {% if dlmuse_path and dlmuse_path contains "=" %}
          {% assign section_dlmuse_path = "" %}
          {% assign dlmuse_parts = dlmuse_path | split: ";" %}
          {% for part in dlmuse_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_dlmuse_path = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_dlmuse_version = dlmuse_version %}
        {% if dlmuse_version and dlmuse_version contains "=" %}
          {% assign section_dlmuse_version = "" %}
          {% assign dlmuse_version_parts = dlmuse_version | split: ";" %}
          {% for part in dlmuse_version_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_dlmuse_version = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_dlmuse_complete = dlmuse_complete %}
        {% if dlmuse_complete and dlmuse_complete contains "=" %}
          {% assign section_dlmuse_complete = "" %}
          {% assign dlmuse_complete_parts = dlmuse_complete | split: ";" %}
          {% for part in dlmuse_complete_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_dlmuse_complete = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_ravens_path = ravens_path %}
        {% if ravens_path and ravens_path contains "=" %}
          {% assign section_ravens_path = "" %}
          {% assign ravens_parts = ravens_path | split: ";" %}
          {% for part in ravens_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_ravens_path = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_ravens_version = ravens_version %}
        {% if ravens_version and ravens_version contains "=" %}
          {% assign section_ravens_version = "" %}
          {% assign ravens_version_parts = ravens_version | split: ";" %}
          {% for part in ravens_version_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_ravens_version = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_ravens_complete = ravens_complete %}
        {% if ravens_complete and ravens_complete contains "=" %}
          {% assign section_ravens_complete = "" %}
          {% assign ravens_complete_parts = ravens_complete | split: ";" %}
          {% for part in ravens_complete_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_ravens_complete = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_dlwmls_path = dlwmls_path %}
        {% if dlwmls_path and dlwmls_path contains "=" %}
          {% assign section_dlwmls_path = "" %}
          {% assign dlwmls_parts = dlwmls_path | split: ";" %}
          {% for part in dlwmls_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_dlwmls_path = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_dlwmls_version = dlwmls_version %}
        {% if dlwmls_version and dlwmls_version contains "=" %}
          {% assign section_dlwmls_version = "" %}
          {% assign dlwmls_version_parts = dlwmls_version | split: ";" %}
          {% for part in dlwmls_version_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_dlwmls_version = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_dlwmls_complete = dlwmls_complete %}
        {% if dlwmls_complete and dlwmls_complete contains "=" %}
          {% assign section_dlwmls_complete = "" %}
          {% assign dlwmls_complete_parts = dlwmls_complete | split: ";" %}
          {% for part in dlwmls_complete_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_dlwmls_complete = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_fmriprep_path = fmriprep_path %}
        {% if fmriprep_path and fmriprep_path contains "=" %}
          {% assign section_fmriprep_path = "" %}
          {% assign fmriprep_parts = fmriprep_path | split: ";" %}
          {% for part in fmriprep_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_fmriprep_path = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_fmriprep_version = fmriprep_version %}
        {% if fmriprep_version and fmriprep_version contains "=" %}
          {% assign section_fmriprep_version = "" %}
          {% assign fmriprep_version_parts = fmriprep_version | split: ";" %}
          {% for part in fmriprep_version_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_fmriprep_version = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_fmriprep_complete = fmriprep_complete %}
        {% if fmriprep_complete and fmriprep_complete contains "=" %}
          {% assign section_fmriprep_complete = "" %}
          {% assign fmriprep_complete_parts = fmriprep_complete | split: ";" %}
          {% for part in fmriprep_complete_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_fmriprep_complete = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_fmriprep_command = fmriprep_command %}
        {% if fmriprep_command and fmriprep_command contains "=" %}
          {% assign section_fmriprep_command = "" %}
          {% assign fmriprep_command_parts = fmriprep_command | split: ";" %}
          {% for part in fmriprep_command_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_fmriprep_command = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_xcpd_path = xcpd_path %}
        {% if xcpd_path and xcpd_path contains "=" %}
          {% assign section_xcpd_path = "" %}
          {% assign xcpd_parts = xcpd_path | split: ";" %}
          {% for part in xcpd_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_xcpd_path = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_xcpd_version = xcpd_version %}
        {% if xcpd_version and xcpd_version contains "=" %}
          {% assign section_xcpd_version = "" %}
          {% assign xcpd_version_parts = xcpd_version | split: ";" %}
          {% for part in xcpd_version_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_xcpd_version = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_xcpd_complete = xcpd_complete %}
        {% if xcpd_complete and xcpd_complete contains "=" %}
          {% assign section_xcpd_complete = "" %}
          {% assign xcpd_complete_parts = xcpd_complete | split: ";" %}
          {% for part in xcpd_complete_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_xcpd_complete = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% assign section_xcpd_command = xcpd_command %}
        {% if xcpd_command and xcpd_command contains "=" %}
          {% assign section_xcpd_command = "" %}
          {% assign xcpd_command_parts = xcpd_command | split: ";" %}
          {% for part in xcpd_command_parts %}
            {% assign part_stripped = part | strip %}
            {% if part_stripped contains key_prefix %}
              {% assign section_xcpd_command = part_stripped | replace_first: key_prefix, "" | strip %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% else %}
        {% assign section_dlmuse_path = dlmuse_path %}
        {% assign section_dlmuse_version = dlmuse_version %}
        {% assign section_dlmuse_complete = dlmuse_complete %}
        {% assign section_ravens_path = ravens_path %}
        {% assign section_ravens_version = ravens_version %}
        {% assign section_ravens_complete = ravens_complete %}
        {% assign section_dlwmls_path = dlwmls_path %}
        {% assign section_dlwmls_version = dlwmls_version %}
        {% assign section_dlwmls_complete = dlwmls_complete %}
        {% assign section_fmriprep_path = fmriprep_path %}
        {% assign section_fmriprep_version = fmriprep_version %}
        {% assign section_fmriprep_complete = fmriprep_complete %}
        {% assign section_fmriprep_command = fmriprep_command %}
        {% assign section_xcpd_path = xcpd_path %}
        {% assign section_xcpd_version = xcpd_version %}
        {% assign section_xcpd_complete = xcpd_complete %}
        {% assign section_xcpd_command = xcpd_command %}
      {% endif %}

      {% assign pipelines = "" | split: "," %}
      {% if section_dlmuse_path and section_dlmuse_path != "" %}{% assign pipelines = pipelines | push: "DLMUSE" %}{% endif %}
      {% if section_ravens_path and section_ravens_path != "" %}{% assign pipelines = pipelines | push: "RAVENS" %}{% endif %}
      {% if section_dlwmls_path and section_dlwmls_path != "" %}{% assign pipelines = pipelines | push: "DLWMLS" %}{% endif %}
      {% if section_fmriprep_path and section_fmriprep_path != "" %}{% assign pipelines = pipelines | push: "fMRIPrep" %}{% endif %}
      {% if section_xcpd_path and section_xcpd_path != "" %}{% assign pipelines = pipelines | push: "XCP-D" %}{% endif %}

      {% for p in pipelines %}
        {% assign p_key = p %}
        {% assign p_id = p | downcase | replace: ".", "-" | replace: " ", "-" %}
        {% assign p_command_col = p_key | append: "_command" %}
        {% assign p_has_command = false %}
        {% assign p_command_raw = "" %}
        
        {% if p == "DLMUSE" %}
          {% assign p_path = section_dlmuse_path %}
          {% assign p_version = section_dlmuse_version %}
          {% assign p_complete = section_dlmuse_complete %}
        {% elsif p == "RAVENS" %}
          {% assign p_path = section_ravens_path %}
          {% assign p_version = section_ravens_version %}
          {% assign p_complete = section_ravens_complete %}
        {% elsif p == "DLWMLS" %}
          {% assign p_path = section_dlwmls_path %}
          {% assign p_version = section_dlwmls_version %}
          {% assign p_complete = section_dlwmls_complete %}
        {% elsif p == "fMRIPrep" %}
          {% assign p_path = section_fmriprep_path %}
          {% assign p_version = section_fmriprep_version %}
          {% assign p_complete = section_fmriprep_complete %}
          {% if section_fmriprep_command and section_fmriprep_command != "" %}
            {% assign p_has_command = true %}
            {% assign p_command_raw = section_fmriprep_command %}
          {% endif %}
        {% elsif p == "XCP-D" %}
          {% assign p_path = section_xcpd_path %}
          {% assign p_version = section_xcpd_version %}
          {% assign p_complete = section_xcpd_complete %}
          {% if section_xcpd_command and section_xcpd_command != "" %}
            {% assign p_has_command = true %}
            {% assign p_command_raw = section_xcpd_command %}
          {% endif %}
        {% endif %}

        {% comment %}Denominator for complete note: DLMUSE/RAVENS use T1_N_ses, DLWMLS uses FL_N_ses, others use N_MR_session{% endcomment %}
        {% assign p_n_ses = section_n_mr_session %}
        {% if p_key == "DLMUSE" or p_key == "RAVENS" %}
          {% if section_t1_n_ses and section_t1_n_ses != "" %}
            {% assign p_n_ses = section_t1_n_ses %}
          {% endif %}
        {% elsif p_key == "DLWMLS" %}
          {% if section_fl_n_ses and section_fl_n_ses != "" %}
            {% assign p_n_ses = section_fl_n_ses %}
          {% endif %}
        {% endif %}

        <tr>
          <th style="font-weight:bold; width:250px;">
            {% if p_key == "DLMUSE" %}
              <a href="https://github.com/CBICA/NiChart_DLMUSE">{{ p_key }}</a>
            {% elsif p_key == "RAVENS" %}
              <a href="https://doi.org/10.1006/nimg.2001.0937">{{ p_key }}</a>
            {% elsif p_key == "DLWMLS" %}
              <a href="https://github.com/CBICA/NiChart_DLWMLS">{{ p_key }}</a>
            {% else %}
              {{ p_key }}
            {% endif %}
            {% if p_version and p_version != "" %}
              <span style="font-weight:normal;">({{ p_version }})</span>
            {% endif %}
            {% if p_complete and p_complete != "" and p_n_ses and p_n_ses != "" %}
              <br>
              <span style="font-weight:normal;">({{ p_complete }}/{{ p_n_ses }} complete)</span>
            {% endif %}
          </th>
          <th style="font-weight:normal">
            {% if p_has_command %}
              {% comment %}Show tabs for Path and Command{% endcomment %}
              <div class="tab-container">
                <div class="tab-buttons">
                  <button class="tab-button active" onclick="showTab('{{ study_abbr | downcase }}-{{ section_key | downcase }}-{{ p_id }}-path-tab')">Path</button>
                  <button class="tab-button" onclick="showTab('{{ study_abbr | downcase }}-{{ section_key | downcase }}-{{ p_id }}-command-tab')">Command</button>
                </div>
                <div id="{{ study_abbr | downcase }}-{{ section_key | downcase }}-{{ p_id }}-path-tab" class="tab-content active">
                  {% assign path_parts = p_path | split: ";" %}
                  {% for part in path_parts %}
                    {% assign part_stripped = part | strip %}
                    {% if part_stripped != "" %}
                       <div id="{{ study_abbr | downcase }}-{{ section_key | downcase }}-{{ p_id }}-path-{{ forloop.index }}" class="copy-container" style="border: 1px solid #6c6edc; border-radius: 3px; padding: 6px; background-color: #f8f9fa; margin-bottom: 15px;">
                          <span class="copy-text"><code>{{ part_stripped }}</code></span>
                          <button class="copy-button" onclick="copyToClipboard('{{ study_abbr | downcase }}-{{ section_key | downcase }}-{{ p_id }}-path-{{ forloop.index }}')">Copy</button>
                        </div>
                    {% endif %}
                  {% endfor %}
                </div>
                <div id="{{ study_abbr | downcase }}-{{ section_key | downcase }}-{{ p_id }}-command-tab" class="tab-content">
                  {% assign command_parts = p_command_raw | split: ";" %}
                  {% for part in command_parts %}
                    {% assign part_stripped = part | strip %}
                    {% if part_stripped != "" %}
                      <div id="{{ study_abbr | downcase }}-{{ section_key | downcase }}-{{ p_id }}-command-{{ forloop.index }}" class="copy-container" style="border: 1px solid #6c6edc; border-radius: 3px; padding: 6px; background-color: #f8f9fa; margin-bottom: 15px; flex-direction: column; align-items: stretch;">
                        <div class="copy-text" style="flex: 1; overflow-x: auto; margin: 0; padding: 8px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 3px;">
                          <code style="display: block; white-space: pre-wrap; word-break: break-all; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4; color: #333;">{{ part_stripped | replace: "<", "&lt;" | replace: ">", "&gt;" }}</code>
                        </div>
                        <button class="copy-button" onclick="copyToClipboard('{{ study_abbr | downcase }}-{{ section_key | downcase }}-{{ p_id }}-command-{{ forloop.index }}')" style="align-self: flex-end; margin-top: 8px;">Copy</button>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            {% else %}
              {% comment %}No command, just show path{% endcomment %}
              <div id="{{ study_abbr | downcase }}-{{ section_key | downcase }}-{{ p_id }}-path" class="copy-container" style="border: 1px solid #6c6edc; border-radius: 3px; padding: 6px; background-color: #f8f9fa;">
                <span class="copy-text"><code>{{ p_path }}</code></span>
                <button class="copy-button" onclick="copyToClipboard('{{ study_abbr | downcase }}-{{ section_key | downcase }}-{{ p_id }}-path')">Copy</button>
              </div>
            {% endif %}
          </th>
          <th style="font-weight:normal"></th>
        </tr>
      {% endfor %}

      {% assign has_nonimaging = true %}
      {% if has_nonimaging %}
        <tr>
          <th style="font-weight:bold; width:250px;">Non-Imaging Data</th>
          <th style="font-weight:normal">
            {% assign nonimg_id = study_abbr | downcase | append: "-" | append: section_key | downcase | append: "-nonimg" %}
            <div class="tab-container">
              <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('{{ nonimg_id }}-raw-tab')">Raw</button>
                <button class="tab-button" onclick="showTab('{{ nonimg_id }}-data-dictionary-tab')">Data Dictionary</button>
                <button class="tab-button" onclick="showTab('{{ nonimg_id }}-consolidated-v2-tab')">Consolidated v2.0</button>
                <button class="tab-button" onclick="showTab('{{ nonimg_id }}-consolidated-latest-tab')">Consolidated Latest</button>
              </div>
              <div id="{{ nonimg_id }}-raw-tab" class="tab-content active">
                {% if nonimaging_raw and nonimaging_raw != "" %}
                  {% assign raw_parts = nonimaging_raw | split: ";" %}
                  {% for part in raw_parts %}
                    {% assign part_stripped = part | strip %}
                    {% if part_stripped != "" %}
                      <div id="{{ nonimg_id }}-raw-{{ forloop.index }}" class="copy-container" style="border: 1px solid #6c6edc; border-radius: 3px; padding: 6px; background-color: #f8f9fa; margin-bottom: 15px;">
                        <span class="copy-text"><code>{{ part_stripped }}</code></span>
                        <button class="copy-button" onclick="copyToClipboard('{{ nonimg_id }}-raw-{{ forloop.index }}')">Copy</button>
                      </div>
                    {% endif %}
                  {% endfor %}
                  <p style="margin-top: 12px; margin-bottom: 0; font-size: 14px; color: #444;">Raw data downloaded from source.</p>
                {% else %}
                  <p style="color:#666;">—</p>
                  <p style="margin-top: 12px; margin-bottom: 0; font-size: 14px; color: #444;">Raw data downloaded from source.</p>
                {% endif %}
              </div>
              <div id="{{ nonimg_id }}-data-dictionary-tab" class="tab-content">
                {% if nonimaging_data_dictionary and nonimaging_data_dictionary != "" %}
                  {% assign dd_parts = nonimaging_data_dictionary | split: ";" %}
                  {% for part in dd_parts %}
                    {% assign part_stripped = part | strip %}
                    {% if part_stripped != "" %}
                      <div id="{{ nonimg_id }}-dd-{{ forloop.index }}" class="copy-container" style="border: 1px solid #6c6edc; border-radius: 3px; padding: 6px; background-color: #f8f9fa; margin-bottom: 15px;">
                        <span class="copy-text"><code>{{ part_stripped }}</code></span>
                        <button class="copy-button" onclick="copyToClipboard('{{ nonimg_id }}-dd-{{ forloop.index }}')">Copy</button>
                      </div>
                    {% endif %}
                  {% endfor %}
                  <p style="margin-top: 12px; margin-bottom: 0; font-size: 14px; color: #444;">Data dictionary of raw data downloaded from source.</p>
                {% else %}
                  <p style="color:#666;">—</p>
                  <p style="margin-top: 12px; margin-bottom: 0; font-size: 14px; color: #444;">Data dictionary of raw data downloaded from source.</p>
                {% endif %}
              </div>
              <div id="{{ nonimg_id }}-consolidated-v2-tab" class="tab-content">
                <div id="{{ nonimg_id }}-v2-path" class="copy-container" style="border: 1px solid #6c6edc; border-radius: 3px; padding: 6px; background-color: #f8f9fa; margin-bottom: 15px;">
                  <span class="copy-text"><code>{{ nonimaging_consolidated_v2 }}</code></span>
                  <button class="copy-button" onclick="copyToClipboard('{{ nonimg_id }}-v2-path')">Copy</button>
                </div>
                <p style="margin-top: 12px; margin-bottom: 8px; font-size: 14px; color: #444;">Data consolidated and harmonized in 2020.</p>
                {% if nonimaging_consolidated_v2_study and nonimaging_consolidated_v2_study != "" %}
                  <p style="margin-top: 0; margin-bottom: 4px; font-size: 14px; color: #444;"><strong>This study:</strong> subset with <code>df[df.Study == '{{ nonimaging_consolidated_v2_study }}']</code></p>
                {% endif %}
                <p style="margin: 6px 0 4px; font-size: 14px; color: #444;">README: <code>{{ nonimaging_consolidation_base }}/README.md</code></p>
                <p style="margin: 6px 0 0; font-size: 14px; color: #444;">Release Notes: <code>{{ nonimaging_consolidation_base }}/Release_Notes.md</code></p>
              </div>
              <div id="{{ nonimg_id }}-consolidated-latest-tab" class="tab-content">
                <div id="{{ nonimg_id }}-latest-path" class="copy-container" style="border: 1px solid #6c6edc; border-radius: 3px; padding: 6px; background-color: #f8f9fa; margin-bottom: 15px;">
                  <span class="copy-text"><code>{{ nonimaging_consolidated_latest }}</code></span>
                  <button class="copy-button" onclick="copyToClipboard('{{ nonimg_id }}-latest-path')">Copy</button>
                </div>
                <p style="margin-top: 12px; margin-bottom: 8px; font-size: 14px; color: #444;">Data consolidated and harmonized in 2026.</p>
                {% if nonimaging_consolidated_v2_study and nonimaging_consolidated_v2_study != "" %}
                  <p style="margin-top: 0; margin-bottom: 4px; font-size: 14px; color: #444;"><strong>This study:</strong> subset with <code>df[df.Study == '{{ nonimaging_consolidated_v2_study }}']</code></p>
                {% endif %}
                <p style="margin: 6px 0 4px; font-size: 14px; color: #444;">README: <code>Coming Soon</code></p>
                <p style="margin: 6px 0 0; font-size: 14px; color: #444;">Release Notes: <code>Coming Soon</code></p>
              </div>
            </div>
          </th>
          <th style="font-weight:normal"></th>
        </tr>
      {% endif %}
    {% endfor %}
  </table>
</div>

{% include datasets/copy_widgets.html %}

{% assign grants = row["Grants"] %}
{% if grants and grants != "" %}
<br>

*Funding*
<br>
{{ grants }}
{% endif %}

{% endif %}

